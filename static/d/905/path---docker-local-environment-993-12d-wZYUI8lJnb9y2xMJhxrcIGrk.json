{"data":{"site":{"siteMetadata":{"title":"Blog","author":"Atul R"}},"markdownRemark":{"id":"11763dc3-44b6-5734-8350-b587d12d9057","excerpt":"I recently started working at  Anyfin . As a new engineer on the team, I had to setup the entire development environment. Drawing my expectations from my previous work engagements I thought this would‚Ä¶","html":"<p>I recently started working at <a href=\"https://anyfin.com/en\" target=\"_blank\">Anyfin</a>. As a new engineer on the team, I had to setup the entire development environment. Drawing my expectations from my previous work engagements I thought this would take me a couple of days. But to my surprise I had a working setup of quite a few backend services written in NodeJS, Golang and Python along side the web site and portal (Javascript) in ~5hrs.\nThis post will explain on how we use Docker at Anyfin to setup a productive local development environment quite easily. I have seen such attempts at my previous workplaces before but none of those have worked as seamlessly as the one we have here.</p>\n<p><strong>üëÆüèª‚ÄçCredit disclaimer:üö®</strong> <br/>\nThe entire credit for the setup goes to my colleagues: <a href=\"https://github.com/kimpers\" target=\"_blank\">Kim</a>, <a href=\"https://github.com/miknie\" target=\"_blank\">Niemi</a>, <a href=\"https://github.com/fatalVoltage\" target=\"_blank\">Asparuh</a>, <a href=\"https://github.com/pepf\" target=\"_blank\">Pepijn</a> and <a href=\"https://github.com/hyperborea\" target=\"_blank\">Sven</a>. I found the setup at Anyfin extremely awesome and hence wanted to share it with everyone.</p>\n<h2>üß¶ Example Architecture</h2>\n<p>Lets say we have a set of services that have the following architecture.</p>\n<p><img src=\"/architecture-f069ee90ad81928b31443a2451837f10.svg\" alt=\"example architecture\"></p>\n<p>From the diagram we can see we have:</p>\n<ul>\n<li>NJS1 - NodeJS service running on port <strong>7000</strong> and dependent on the database Db1 (running on port <strong>5433</strong>).</li>\n<li>Py1 - Python service running on port <strong>9000</strong> and dependent on the database Db1 (running on port <strong>5433</strong>).</li>\n<li>Go1 - Golang service running on port <strong>5000</strong> and dependent on the database Db1 (running on port <strong>5433</strong>).</li>\n</ul>\n<hr>\n<ul>\n<li>NJS2 - NodeJS service running on port <strong>8000</strong> and dependent on the database Db2 (running on port <strong>5432</strong>).</li>\n</ul>\n<hr>\n<ul>\n<li>Web - A simple webpack based dev server for frontend running on port <strong>8080</strong>.</li>\n</ul>\n<p><em>PS: We want the services to be exposed on the said ports in the local environment so that they can communicate with each other via those.</em></p>\n<p>For simplicity, lets consider that all of these services just return the message:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hello from &lt;service name&gt;</code></pre></div>\n<p>So, if you hit <strong>GET <a href=\"http://localhost:7000\">http://localhost:7000</a></strong>, you should get</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hello from njs1</code></pre></div>\n<p>The code for these services are here: <a href=\"https://github.com/master-atul/blog-docker-dev-environment-example\" target=\"_blank\">https://github.com/master-atul/blog-docker-dev-environment-example</a></p>\n<p>Lets run all of our services on different terminal windows and try it out.\n<br/></p>\n<h2>üí© We typically face these issues with this setup</h2>\n<ol>\n<li><strong>Terminal hell:</strong> To run all of those services, we would need to open up mulitple terminal tabs/windows and then run them separately (It would look like this). This will become more harder to manage as the number of services grow.</li>\n</ol>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0b1a5d3c267b9065b66bfb6f05578712/e2b4a/example_terminal.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width:100% !important; max-width: 800px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 54.85674353598882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABu0lEQVQoz2WS667iMAyE+waIy7alhZ+AhACptyRNeoGCeP83mvV4qQ5H+8NK08Sfx+NEfbCojUFVVmiaBkVZwlqL0HVwzmmE0KGTfdsPCMOIQaLve/kf9Jt3jbGS5xCt1imSJMZms8F2u8ViscDxeNQEggnkaqVYfb+j8B5WBHQs8ikUfEBVVSKqRJQkuYLiOEGe51itVjgcDmjbVqoahVF5WRRoRY2R/651GKcevm/Rdk5XF5ycGUR/4kyAqQBjZFmmQCr0ooRAwhhU4EV1Q7WugR9kDTWML8WyUqwqUFblN/BH4el0Un8IrOtaYVTopD3LlgmVMFY6EEtMI/eqWu9GcbITUIY0TbHf79XLb+AMpcpWksdxQE/wlx08n+MXcLfbYb1e43K54Pl8quHDMCicw/EC6ATUG2m5kSICKGUQ3xHFcS7ebWXSPy1fr1e832+FMqZpUk8ZcwEOLXy3/+lEPaS6eSjL5RLn81khTB7Hf2+u03dpdZ33s3LG/CL+mzKBt9sNr9dLk6iQlQkZZf+QlYW4p8r5FRDI4YmHv1smkC0TxKTH46EJnXzfBfQU5dMneMY7/tM6C/8F4WxYqCLBpNAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"example terminal\"\n        title=\"\"\n        src=\"/static/0b1a5d3c267b9065b66bfb6f05578712/b8742/example_terminal.png\"\n        srcset=\"/static/0b1a5d3c267b9065b66bfb6f05578712/0a321/example_terminal.png 200w,\n/static/0b1a5d3c267b9065b66bfb6f05578712/91860/example_terminal.png 400w,\n/static/0b1a5d3c267b9065b66bfb6f05578712/b8742/example_terminal.png 800w,\n/static/0b1a5d3c267b9065b66bfb6f05578712/d1b00/example_terminal.png 1200w,\n/static/0b1a5d3c267b9065b66bfb6f05578712/27d18/example_terminal.png 1600w,\n/static/0b1a5d3c267b9065b66bfb6f05578712/299ac/example_terminal.png 2400w,\n/static/0b1a5d3c267b9065b66bfb6f05578712/e2b4a/example_terminal.png 2862w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n  </span>\n  </a></p>\n<center><sub><i>Typical terminal layout of a developer working with multiple services</i></sub></center>\n<br/>\n<ol start=\"2\">\n<li>\n<p><strong>Incompatible dependencies</strong>: Lets say our services depend on different node versions. In such cases we would need to manually switch node versions before running our services. Similarly, if our services depend on multiple database servers, then we would need to make sure our database servers are running (on different ports) before we can run our services. All of this is mostly manual and cumbersome.</p>\n</li>\n<li>\n<p><strong>Fresh setup</strong>: Setting up all of this services on a new machine can be tricky as we need to keep track of all the dependencies we need and their corresponding versions. This leads to the popular <strong>‚ÄúWorks on my machine‚Äù</strong>.</p>\n</li>\n</ol>\n<p>All of these are frankly annoying ü§Ø.</p>\n<h2>üï∂ Docker based local development environment</h2>\n<blockquote>\n<p>Docker is a tool designed to make it easier to create, deploy, and run applications by using containers. Containers allow a developer to package up an application with all of the parts it needs, such as libraries and other dependencies, and ship it all out as one package.</p>\n</blockquote>\n<h3>Mental model üßû‚Äç</h3>\n<h4>Docker container</h4>\n<p>To form a mental picture, for the time being just consider a <strong>Docker Container</strong> as an extremely light weight isolated linux based virtual machine inside which we will run our application service (<a href=\"https://www.backblaze.com/blog/vm-vs-containers/\" target=\"_blank\">although containers are not exactly VMs</a>). The container will contain our code and all of its dependencies (system libraries, tools, etc). For our setup we will use one docker container per service and separate docker containers for our database.</p>\n<p><img src=\"/containers_mental_modal-413c6e75962d7baf8224cf72b52dac28.svg\" alt=\"containers_mental_modal\"></p>\n<h4>Docker-Compose</h4>\n<blockquote>\n<p>Docker compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your application‚Äôs services. Then, with a single command, you create and start all the services from your configuration.</p>\n</blockquote>\n<p><strong>TLDR;</strong> Docker compose lets you run all your services at once (also in the right order) and manage them via a unified interface.</p>\n<p>Docker compose in general will contain:</p>\n<ul>\n<li>\n<p><strong>Services</strong>: Services are the list of induvidual docker containers that will be run by the compose tool. We will specify the ports and other configurations needed to run the docker containers here.</p>\n</li>\n<li>\n<p><strong>Networks</strong>: Network provides a way by which different services can interact with each other. Each container can attach itself to a network and all containers within same networks can communicate with each other. We will use a single network for our case.</p>\n</li>\n<li>\n<p><strong>Volumes</strong>: Docker containers by default do not contain any kind of persistence storage. If a docker container is killed then all the data in its memory gets lost. So in order to save some persistant data you need volumes. Think of volumes as permanent hard drives for these containers. We will have one volume per service.</p>\n</li>\n</ul>\n<p><img src=\"/compose_mental_modal-5c736f83bee4417992e76fd0dcf5e271.svg\" alt=\"compose_modal\"></p>\n<br/>\n<h2>üöÄ Setting it up</h2>\n<p>Firstly, make sure you have docker running by following the instructions here <a href=\"https://www.docker.com/get-started\" target=\"_blank\">https://www.docker.com/get-started</a>.</p>\n<p>Lets take a look at what a simple docker-compose file looks like:</p>\n<p><strong><code class=\"language-text\">docker-compose.yml</code></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">&lt;service_name_1></span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> &lt;path_to_docker_file_of_service<span class=\"token punctuation\">></span>\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> &lt;start_command_to_run<span class=\"token punctuation\">></span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> &lt;env_var_1<span class=\"token punctuation\">></span>=&lt;env_val_1<span class=\"token punctuation\">></span>\n      <span class=\"token punctuation\">-</span> &lt;env_var_2<span class=\"token punctuation\">></span>=&lt;env_val_2<span class=\"token punctuation\">></span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'&lt;port_inside_container>:&lt;port_of_host_machine>'</span>\n    <span class=\"token key atrule\">working_dir</span><span class=\"token punctuation\">:</span> &lt;path_inside_the_docker_container_where_command_should_run<span class=\"token punctuation\">></span>\n\n  <span class=\"token key atrule\">&lt;service_name_2></span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">...</span>.\n    <span class=\"token punctuation\">...</span>.\n    <span class=\"token punctuation\">...</span>.</code></pre></div>\n<p>For our NJS1 (node js app) it would look like:</p>\n<p><strong><code class=\"language-text\">docker-compose.yml</code></strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">njs1</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> ./njs1\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> sh <span class=\"token punctuation\">-</span>c \"npm install &amp;&amp; npm start\"\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> NODE_ENV=development\n      <span class=\"token punctuation\">-</span> PORT=7000\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'7000:7000'</span>\n    <span class=\"token key atrule\">working_dir</span><span class=\"token punctuation\">:</span> /root/njs1</code></pre></div>\n<p>The above docker compose file has only one service (njs1). We will add more services incrementally. Before that lets run it and see what we get.</p>\n<p>To run :</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"></code></pre></div>\n<p>// explain services section separately</p>\n<p>// and then show the completed file and explain a bit.</p>\n<h2>üßô‚Äç Commands Cheatsheet</h2>\n<p>// Start command</p>\n<p>// stop command</p>\n<p>// stop a single service</p>\n<p>// restart a single service</p>\n<p>// ssh into single service</p>\n<h2>üïµÔ∏è‚Äç Some Tips for smoother workflow</h2>\n<p>// CPU and memory increase</p>\n<p>// removing all images and then refreshing the entire thing.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"></code></pre></div>","frontmatter":{"title":"üê≥ Simplified guide to using Docker for local development environment","date":"March 26, 2019","keywords":"docker, local, development, environment, guide, javascript","featuredImage":{"childImageSharp":null}},"fields":{"slug":"/docker-local-environment/"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/docker-local-environment/","previous":{"fields":{"slug":"/rate-limiter/"},"frontmatter":{"title":"üöß An alternative approach to building a simple API Rate limiter using NodeJS and Redis"}},"next":null}}